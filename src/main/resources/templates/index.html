<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:hx="http://www.thymeleaf.org/extras/htmx"
      layout:decorate="~{base}" lang="en">
<head>
    <title th:text="#{page.title.welcome}">Welcome - Landing Page AI Generator</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
</head>
<body>
    <div layout:fragment="content" class="min-h-screen pb-48 sm:pb-56" x-data="{ 
        prompt: '', 
        generatedContent: '', 
        hasContent: false,
        previewForm: null,
        initPreviewForm() {
            this.previewForm = document.createElement('form');
            this.previewForm.method = 'POST';
            this.previewForm.action = '/api/ai/preview';
            this.previewForm.target = '_blank';
            this.previewForm.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'htmlContent';
            
            this.previewForm.appendChild(input);
            document.body.appendChild(this.previewForm);
        }
    }" x-init="initPreviewForm">
        <!-- Hero Section -->
        <div class="max-w-4xl mx-auto text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-6xl">
                <span th:text="#{hero.title}">Generate Beautiful Landing Pages with AI</span>
            </h1>
            <p class="mt-6 text-lg leading-8 text-gray-600 dark:text-gray-300">
                <span th:text="#{hero.description}">Create stunning, responsive landing pages in minutes using the power of artificial intelligence. No coding required.</span>
            </p>
        </div>

        <!-- Preview Section -->
        <div x-show="hasContent" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform -translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="max-w-5xl mx-auto mb-8">
            <!-- Preview iframe -->
            <div class="relative rounded-lg border border-gray-200 dark:border-gray-700 bg-white">
                <div class="absolute top-0 left-0 right-0 h-8 bg-gray-100 dark:bg-gray-700 rounded-t-lg border-b border-gray-200 dark:border-gray-600 flex items-center px-4">
                    <div class="flex space-x-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    </div>
                </div>
                <div class="p-4">
                    <div x-show="!hasContent" 
                         class="htmx-indicator flex items-center justify-center h-[400px]">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                    </div>
                    <div x-show="hasContent"
                         x-ref="previewContent"
                         class="w-full min-h-[400px] bg-white"
                         x-html="generatedContent.replace(/^```html\s*/, '').replace(/```$/, '').trim()"
                         x-init="$watch('generatedContent', value => {
                             if (value) {
                                 console.log('Content updated:', value);
                                 hasContent = true;
                             }
                         })">
                    </div>
                </div>
            </div>

            <!-- Source code -->
            <div class="mt-4 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-t-lg border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">Source Code:</h4>
                    <div class="flex gap-2">
                        <button type="button"
                                @click="(() => {
                                    previewForm.querySelector('input').value = generatedContent;
                                    previewForm.submit();
                                })"
                                class="btn btn-primary text-sm">
                            <span th:text="#{button.preview}">Afficher la page</span>
                        </button>
                        <button type="button"
                                @click="navigator.clipboard.writeText(generatedContent)"
                                class="btn btn-secondary text-sm">
                            <span th:text="#{button.copy}">Copy HTML</span>
                        </button>
                    </div>
                </div>
                <div class="relative">
                    <div class="htmx-indicator absolute inset-0 bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                    </div>
                    <pre class="p-4 overflow-x-auto text-sm text-gray-600 dark:text-gray-300" x-text="generatedContent"></pre>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 p-4 sm:p-6 shadow-lg">
            <div class="container mx-auto max-w-4xl">
                <div class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-1 relative w-full">
                        <textarea x-model="prompt"
                            class="input w-full min-h-[100px] sm:min-h-[120px] resize-none pr-12 text-sm sm:text-base leading-relaxed"
                            th:placeholder="#{input.placeholder}"
                            rows="3"
                        ></textarea>
                        <div class="absolute bottom-3 right-3 text-xs sm:text-sm text-gray-400 dark:text-gray-500">
                            <span class="font-medium" th:text="#{input.shortcut.ctrl}">Ctrl</span>
                            <span th:text="#{input.shortcut.separator}">+</span>
                            <span class="font-medium" th:text="#{input.shortcut.enter}">Enter</span>
                        </div>
                    </div>
                    <button type="button"
                            @click="(() => {
                                if (!prompt.trim()) return;
                                generatedContent = '';
                                hasContent = false;
                                
                                // Store EventSource instance in a variable for cleanup
                                let currentEventSource = null;
                                
                                // Function to safely close the connection
                                const closeConnection = () => {
                                    if (currentEventSource) {
                                        currentEventSource.close();
                                        currentEventSource = null;
                                    }
                                };
                                
                                // Create new EventSource connection
                                currentEventSource = new EventSource(`/api/ai/generate-landing-page-stream?prompt=${encodeURIComponent(prompt)}`);
                                
                                currentEventSource.onmessage = (event) => {
                                    console.log('SSE message received:', event);
                                    const rawData = event.data.replace(/^data: /, '');
                                    console.log('Raw data:', rawData);
                                    try {
                                        const data = JSON.parse(rawData);
                                        console.log('Parsed data:', data);
                                        if (data.error) {
                                            console.error('Error received:', data.error);
                                            generatedContent = `Error: ${data.error}`;
                                            closeConnection();
                                        } else if (data.content) {
                                            console.log('Content received:', data.content);
                                            // Keep the content as is for both preview and source code
                                            generatedContent = (generatedContent || '') + data.content;
                                            // Only close if we have a complete HTML document
                                            if (data.content.includes('</html>') && data.content.includes('<!DOCTYPE html>')) {
                                                closeConnection();
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Error parsing SSE data:', e);
                                        // Don't close the connection on parse errors, just log them
                                    }
                                };

                                currentEventSource.onerror = (error) => {
                                    console.error('SSE error:', error);
                                    // Only set error message if we haven't received any content yet
                                    if (!generatedContent) {
                                        generatedContent = 'Error: Failed to generate content';
                                    }
                                    closeConnection();
                                };

                                currentEventSource.onopen = () => {
                                    console.log('SSE connection opened');
                                };
                            })()"
                            x-init="() => {
                                return () => {
                                    if (currentEventSource) {
                                        currentEventSource.close();
                                        currentEventSource = null;
                                    }
                                }
                            }"
                            :disabled="!prompt.trim()"
                            :class="{ 'opacity-50 cursor-not-allowed': !prompt.trim() }"
                            class="btn btn-primary w-full sm:w-auto whitespace-nowrap px-6 sm:px-8 py-2.5 sm:py-3 text-sm sm:text-base font-medium 
                                   shadow-sm hover:shadow-md transition-all duration-200 
                                   flex items-center justify-center gap-2
                                   transform active:scale-95 hover:-translate-y-0.5
                                   active:bg-primary-700
                                   focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2
                                   animate-in zoom-in-50 duration-300">
                        <span class="htmx-indicator" id="loading-indicator">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        <span th:text="#{button.generate}" 
                              class="relative inline-block transition-transform duration-200 group-hover:transform group-hover:translate-x-1">
                            Generate
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
